module gb
    use iso_fortran_env
    use mpi_f08
    implicit none

    interface gb_bcast
        module procedure gb_bcast_standard
        module procedure gb_bcast_r64_inferred
    end interface

    contains

        !function get_mpi_datatype(element) result(datatype)
        !    use mpi_f08
        !    TYPE(*) :: element
        !    TYPE(MPI_Datatype) :: datatype
        !    !if (same_type_as(element,real(0,kind=REAL64))) then
        !    !if (extends_type_of(element,real(0,kind=REAL64))) then
        !    !    datatype = MPI_DOUBLE_PRECISION
        !    !    return
        !    !endif
        !    select type(element)
        !      type is ( real(kind=REAL64) )
        !    end select
        !end function

        ! MPI standard direct wrapper
        subroutine gb_bcast_standard(buffer, count, datatype, root, comm, ierror)
            use mpi_f08
            TYPE(*), DIMENSION(..) :: buffer
            INTEGER, INTENT(IN) :: count, root
            TYPE(MPI_Datatype), INTENT(IN) :: datatype
            TYPE(MPI_Comm), INTENT(IN) :: comm
            INTEGER, OPTIONAL, INTENT(OUT) :: ierror
            if (present(ierror)) then
                call mpi_bcast(buffer, count, datatype, root, comm, ierror)
            else
                call mpi_bcast(buffer, count, datatype, root, comm)
            endif
        end subroutine

        subroutine gb_bcast_r64_inferred(buffer, root, comm, ierror)
            use mpi_f08
            real(kind=REAL64), DIMENSION(..) :: buffer
            INTEGER, INTENT(IN) :: root
            TYPE(MPI_Comm), INTENT(IN) :: comm
            INTEGER, OPTIONAL, INTENT(OUT) :: ierror

            integer :: count, ndim, dims(15)
            TYPE(MPI_Datatype), parameter :: datatype = MPI_DOUBLE_PRECISION
            count = size(buffer)
            write(*,'(a34,i14)') 'gb_bcast_r64_inferred with count=',count
            ndim = size(shape(buffer))
            dims(1:ndim) = shape(buffer)
            write(*,'(a33,i14)') 'gb_bcast_r64_inferred with ndim=',ndim
            print*,'gb_bcast_r64_inferred with shape=',shape(buffer)

            
            if (present(ierror)) then
                call mpi_bcast(buffer, count, datatype, root, comm, ierror)
            else
                call mpi_bcast(buffer, count, datatype, root, comm)
            endif
        end subroutine


end module gb
